/**
 * jQuery gMap v3
 *
 * @url         http://www.smashinglabs.pl/gmap
 * @author      Sebastian Poreba <sebastian.poreba@gmail.com>
 * @version     3.3.0 beta
 * @date        18.09.2011
 */
(function(i){var k=function(){this.markers=[];this.mainMarker=!1;this.icon="http://www.google.com/mapfiles/marker.png"};k.prototype.dist=function(a){return Math.sqrt(Math.pow(this.markers[0].latitude-a.latitude,2)+Math.pow(this.markers[0].longitude-a.longitude,2))};k.prototype.setIcon=function(a){this.icon=a};k.prototype.addMarker=function(a){this.markers[this.markers.length]=a};k.prototype.getMarker=function(){if(this.mainmarker)return this.mainmarker;var a,b;this.markers.length>1?(a=new d.MarkerImage("http://thydzik.com/thydzikGoogleMap/markerlink.php?text="+
this.markers.length+"&color=EF9D3F"),b="cluster of "+this.markers.length+" markers"):(a=new d.MarkerImage(this.icon),b=this.markers[0].title);return this.mainmarker=new d.Marker({position:new d.LatLng(this.markers[0].latitude,this.markers[0].longitude),icon:a,title:b,map:null})};var d=google.maps,m=new d.Geocoder,o=0,p=0,g={},g={init:function(a){var b,c=i.extend({},i.fn.gMap.defaults,a);for(b in i.fn.gMap.defaults.icon)c.icon[b]||(c.icon[b]=i.fn.gMap.defaults.icon[b]);return this.each(function(){var a=
i(this),b=g._getMapCenter.apply(a,[c]);if(c.zoom=="fit")c.zoom=g._autoZoom.apply(a,[c]);var n=new d.Map(this,{zoom:c.zoom,center:b,mapTypeControl:c.mapTypeControl,zoomControl:c.zoomControl,panControl:c.panControl,scaleControl:c.scaleControl,streetViewControl:c.streetViewControl,mapTypeId:c.maptype,scrollwheel:c.scrollwheel,maxZoom:c.maxZoom,minZoom:c.minZoom});c.log&&console.log("map center is:");c.log&&console.log(b);a.data("$gmap",n);a.data("gmap",{opts:c,gmap:n,markers:[],markerKeys:{},infoWindow:null,
clusters:[]});if(c.controls.length!==0)for(b=0;b<c.controls.length;b+=1)n.controls[c.controls[b].pos].push(c.controls[b].div);c.clustering.enabled?(b=a.data("gmap"),b.markers=c.markers,g._renderCluster.apply(a,[]),d.event.addListener(n,"bounds_changed",function(){g._renderCluster.apply(a,[])})):c.markers.length!==0&&g.addMarkers.apply(a,[c.markers]);g._onComplete.apply(a,[])})},_onComplete:function(){var a=this.data("gmap"),b=this;if(o!==0)window.setTimeout(function(){g._onComplete.apply(b,[])},1E3);
else a.opts.onComplete()},_setMapCenter:function(a){var b=this.data("gmap");b.opts.log&&console.log("delayed setMapCenter called");if(b.gmap!==void 0)b.gmap.setCenter(a);else{var c=this;window.setTimeout(function(){g._setMapCenter.apply(c,[a])},500)}},_boundaries:null,_getBoundaries:function(a){var a=a.markers,b;if(a){var c=a[0].latitude,f=a[0].longitude,e=a[0].longitude,d=a[0].latitude;for(b=1;b<a.length;b+=1){if(c>a[b].latitude)c=a[b].latitude;if(f<a[b].longitude)f=a[b].longitude;if(e>a[b].longitude)e=
a[b].longitude;if(d<a[b].latitude)d=a[b].latitude}g._boundaries={N:c,E:f,W:e,S:d}}else g._boundaries={N:0,E:0,W:0,S:0};return g._boundaries},_getMapCenter:function(a){var b,c=this,f,e;if(a.markers.length&&(a.latitude=="fit"||a.longitude=="fit"))return b=g._getBoundaries(a,!0),b=new d.LatLng((b.N+b.S)/2,(b.E+b.W)/2);if(a.latitude&&a.longitude)return b=new d.LatLng(a.latitude,a.longitude);else b=new d.LatLng(0,0);if(a.address)return m.geocode({address:a.address},function(b,e){e===google.maps.GeocoderStatus.OK?
g._setMapCenter.apply(c,[b[0].geometry.location]):a.log&&console.log("Geocode was not successful for the following reason: "+e)}),b;if(a.markers.length>0){e=null;for(f=0;f<a.markers.length;f+=1)if(a.markers[f].setCenter){e=a.markers[f];break}if(e===null)for(f=0;f<a.markers.length;f+=1){if(a.markers[f].latitude&&a.markers[f].longitude){e=a.markers[f];break}a.markers[f].address&&(e=a.markers[f])}if(e===null)return b;if(e.latitude&&e.longitude)return new d.LatLng(e.latitude,e.longitude);e.address&&m.geocode({address:e.address},
function(b,e){e===google.maps.GeocoderStatus.OK?g._setMapCenter.apply(c,[b[0].geometry.location]):a.log&&console.log("Geocode was not successful for the following reason: "+e)})}return b},_renderCluster:function(){var a=this.data("gmap"),b=a.markers,c=a.clusters,f=a.opts,e;for(e=0;e<c.length;e+=1)c[e].getMarker().setMap(null);c.length=0;if(e=a.gmap.getBounds()){var d=e.getNorthEast(),h=e.getSouthWest(),j=[],i=(d.lat()-h.lat())*f.clustering.clusterSize/100;for(e=0;e<b.length;e+=1)b[e].latitude<d.lat()&&
b[e].latitude>h.lat()&&b[e].longitude<d.lng()&&b[e].longitude>h.lng()&&(j[j.length]=b[e]);f.log&&console.log("number of markers "+j.length+"/"+b.length);f.log&&console.log("cluster radius: "+i);for(e=0;e<j.length;e+=1){d=-1;for(b=0;b<c.length;b+=1)if(h=c[b].dist(j[e]),h<i&&(d=b,f.clustering.fastClustering))break;d===-1?(b=new k,b.addMarker(j[e]),c[c.length]=b):c[d].addMarker(j[e])}f.log&&console.log("Total clusters in viewport: "+c.length);for(b=0;b<c.length;b+=1)c[b].getMarker().setMap(a.gmap)}else{var l=
this;window.setTimeout(function(){g._renderCluster.apply(l)},1E3)}},_processMarker:function(a,b,c,f){var e=this.data("gmap"),g=e.gmap,h=e.opts,j;f===void 0&&(f=new d.LatLng(a.latitude,a.longitude));if(!b)var i={image:h.icon.image,iconSize:new d.Size(h.icon.iconsize[0],h.icon.iconsize[1]),iconAnchor:new d.Point(h.icon.iconanchor[0],h.icon.iconanchor[1]),infoWindowAnchor:new d.Size(h.icon.infowindowanchor[0],h.icon.infowindowanchor[1])},b=new d.MarkerImage(i.image,i.iconSize,null,i.iconAnchor);c||(new d.Size(h.icon.shadowsize[0],
h.icon.shadowsize[1]),i&&i.iconAnchor||new d.Point(h.icon.iconanchor[0],h.icon.iconanchor[1]));b={position:f,icon:b,title:a.title,map:null};if(!h.clustering.enabled)b.map=g;j=new d.Marker(b);j.setShadow(c);e.markers.push(j);a.key&&(e.markerKeys[a.key]=j);var l;a.html&&(c={content:typeof a.html==="string"?h.html_prepend+a.html+h.html_append:a.html,pixelOffset:a.infoWindowAnchor},h.log&&console.log("setup popup with data"),h.log&&console.log(c),l=new d.InfoWindow(c),d.event.addListener(j,"click",function(){h.log&&
console.log("opening popup "+a.html);h.singleInfoWindow&&e.infoWindow&&e.infoWindow.close();l.open(g,j);e.infoWindow=l}));if(a.html&&a.popup)h.log&&console.log("opening popup "+a.html),l.open(g,j),e.infoWindow=l},_geocodeMarker:function(a,b,c){var f=this;m.geocode({address:a.address},function(e,i){i===d.GeocoderStatus.OK?(o-=1,f.data("gmap").opts.log&&console.log("Geocode was successful with point: ",e[0].geometry.location),g._processMarker.apply(f,[a,b,c,e[0].geometry.location])):(i===d.GeocoderStatus.OVER_QUERY_LIMIT&&
(!f.data("gmap").opts.noAlerts&&p===0&&alert("Error: too many geocoded addresses! Switching to 1 marker/s mode."),p+=1E3,window.setTimeout(function(){g._geocodeMarker.apply(f,[a,b,c])},p)),f.data("gmap").opts.log&&console.log("Geocode was not successful for the following reason: "+i))})},_autoZoom:function(a){var b=i(this).data("gmap"),b=i.extend({},b?b.opts:{},a),c,d,a=39135.758482;b.log&&console.log("autozooming map");c=g._getBoundaries(b);b=(c.E-c.W)*111E3/this.width();d=(c.S-c.N)*111E3/this.height();
for(c=2;c<20;c+=1){if(b>a||d>a)break;a/=2}return c-2},addMarkers:function(a){var b=this.data("gmap").opts;if(a.length!==0){b.log&&console.log("adding "+a.length+" markers");for(b=0;b<a.length;b+=1)g.addMarker.apply(this,[a[b]])}},addMarker:function(a){var b=this.data("gmap").opts;b.log&&console.log("putting marker at "+a.latitude+", "+a.longitude+" with address "+a.address+" and html "+a.html);var c=b.icon.image,f=new d.Size(b.icon.iconsize[0],b.icon.iconsize[1]),e=new d.Point(b.icon.iconanchor[0],
b.icon.iconanchor[1]),i=new d.Size(b.icon.infowindowanchor[0],b.icon.infowindowanchor[1]),h=b.icon.shadow,j=new d.Size(b.icon.shadowsize[0],b.icon.shadowsize[1]),k=e;a.infoWindowAnchor=i;if(a.icon){if(a.icon.image)c=a.icon.image;a.icon.iconsize&&(f=new d.Size(a.icon.iconsize[0],a.icon.iconsize[1]));a.icon.iconanchor&&(e=new d.Point(a.icon.iconanchor[0],a.icon.iconanchor[1]));a.icon.infowindowanchor&&new d.Size(a.icon.infowindowanchor[0],a.icon.infowindowanchor[1]);if(a.icon.shadow)h=a.icon.shadow;
a.icon.shadowsize&&(j=new d.Size(a.icon.shadowsize[0],a.icon.shadowsize[1]))}c=new d.MarkerImage(c,f,null,e);h=new d.MarkerImage(h,j,null,k);if(a.address){if(a.html==="_address")a.html=a.address;if(a.title=="_address")a.title=a.address;b.log&&console.log("geocoding marker: "+a.address);o+=1;g._geocodeMarker.apply(this,[a,c,h])}else{if(a.html==="_latlng")a.html=a.latitude+", "+a.longitude;if(a.title=="_latlng")a.title=a.latitude+", "+a.longitude;b=new d.LatLng(a.latitude,a.longitude);g._processMarker.apply(this,
[a,c,h,b])}},removeAllMarkers:function(){var a=this.data("gmap").markers,b;for(b=0;b<a.length;b+=1)a[b].setMap(null),delete a[b];a.length=0},getMarker:function(a){return this.data("gmap").markerKeys[a]},fixAfterResize:function(a){var b=this.data("gmap");d.event.trigger(b.gmap,"resize");a&&b.gmap.panTo(new google.maps.LatLng(0,0));b.gmap.panTo(this.gMap("_getMapCenter",b.opts))},setZoom:function(a,b){var c=this.data("gmap").gmap;a==="fit"&&(a=g._autoZoom.apply(this,[b]));c.setZoom(parseInt(a))},changeSettings:function(a){var b=
this.data("gmap"),c=[],d;for(d=0;d<b.markers.length;d+=1)c[d]={latitude:b.markers[d].getPosition().lat(),longitude:b.markers[d].getPosition().lng()};a.markers=c;a.zoom&&g.setZoom.apply(this,[a.zoom,a]);(a.latitude||a.longitude)&&b.gmap.panTo(g._getMapCenter.apply(this,[a]))},mapclick:function(a){google.maps.event.addListener(this.data("gmap").gmap,"click",function(b){a(b.latLng)})},geocode:function(a,b){m.geocode({address:a},function(a,f){f===d.GeocoderStatus.OK&&b(a[0].geometry.location)})},getRoute:function(a){var b=
this.data("gmap"),c=b.gmap,f=new d.DirectionsRenderer,e=new d.DirectionsService,g={BYCAR:d.DirectionsTravelMode.DRIVING,BYBICYCLE:d.DirectionsTravelMode.BICYCLING,BYFOOT:d.DirectionsTravelMode.WALKING},h={MILES:d.DirectionsUnitSystem.IMPERIAL,KM:d.DirectionsUnitSystem.METRIC},j=null,k=null,l=null;a.routeDisplay!==void 0?j=a.routeDisplay instanceof jQuery?a.routeDisplay[0]:typeof a.routeDisplay=="string"?i(a.routeDisplay)[0]:null:b.opts.routeFinder.routeDisplay!==null&&(j=b.opts.routeFinder.routeDisplay instanceof
jQuery?b.opts.routeFinder.routeDisplay[0]:typeof b.opts.routeFinder.routeDisplay=="string"?i(b.opts.routeFinder.routeDisplay)[0]:null);f.setMap(c);j!==null&&f.setPanel(j);k=g[b.opts.routeFinder.travelMode]!==void 0?g[b.opts.routeFinder.travelMode]:g.BYCAR;l=h[b.opts.routeFinder.travelUnit]!==void 0?h[b.opts.routeFinder.travelUnit]:h.KM;e.route({origin:a.from,destination:a.to,travelMode:k,unitSystem:l},function(a,c){c==d.DirectionsStatus.OK?f.setDirections(a):j!==null&&i(j).html(b.opts.routeFinder.routeErrors[c])});
return this}};i.fn.gMap=function(a){if(g[a])return g[a].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof a==="object"||!a)return g.init.apply(this,arguments);else i.error("Method "+a+" does not exist on jQuery.gmap")};i.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,maxZoom:null,minZoom:null,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,singleInfoWindow:!0,
html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34]},onComplete:function(){},routeFinder:{travelMode:"BYCAR",travelUnit:"KM",routeDisplay:null,routeErrors:{INVALID_REQUEST:"The provided request is invalid.",NOT_FOUND:"One or more of the given addresses could not be found.",OVER_QUERY_LIMIT:"A temporary error occured. Please try again in a few minutes.",
REQUEST_DENIED:"An error occured. Please contact us.",UNKNOWN_ERROR:"An unknown error occured. Please try again.",ZERO_RESULTS:"No route could be found within the given addresses."}},clustering:{enabled:!1,fastClustering:!1,clusterCount:10,clusterSize:40}}})(jQuery);